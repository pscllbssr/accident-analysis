---
title: "Analysis"
author: ""
output: html_document
date: "2023-01-30"
---

# Loading the datasets

## accidents

Load the accidents dataset, already downloaded. 
Source: https://data.geo.admin.ch/ch.astra.unfaelle-personenschaeden_alle/

```{r setup}
library(data.table)

accidents_df <- data.frame(fread("data/RoadTrafficAccidentLocations.csv"))
columns <- c("AccidentUID", "AccidentType", "AccidentType_en", "AccidentSeverityCategory", "AccidentSeverityCategory_en", "AccidentInvolvingPedestrian", "AccidentInvolvingBicycle", "AccidentInvolvingMotorcycle", "RoadType", "RoadType_en", "AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "CantonCode", "MunicipalityCode", "AccidentYear", "AccidentMonth", "AccidentWeekDay", "AccidentHour")
accidents_df <- accidents_df[columns]
head(accidents_df)
```

## Temperature stations

To merge with weather info we load daily measurements from the swiss climate network. First we get the stations...

```{r weather_stations}
weather_stations <- read.csv("data/liste-download-nbcn-d.csv", sep = ';', encoding = "latin1", nrows = 29)
head(weather_stations)
```

## Temperature

...and then we load the time series for every station.

```{r weather, echo=FALSE}
library(readr)

# get vector of download-URLs
download_urls <- weather_stations$URL.Previous.years..verified.data.

# set up empty data frame
temp_data <- data.frame()

# loop over urls and dowload data for every station
for(url in download_urls){
  df <- read_delim(url, delim= ';', col_select = c('date', "station/location", "tre200d0", "tre200dx", "tre200dn"))
  temp_data <- rbind(temp_data, df)

}

head(temp_data)
````


Convert into usable data types
```{r change_data_types}
library(lubridate)
temp_data$date <- ymd(temp_data$date)
temp_data$tre200dn <- as.numeric(temp_data$tre200dn)
temp_data$tre200dx <- as.numeric(temp_data$tre200dx)
temp_data$tre200d0 <- as.numeric(temp_data$tre200d0)
```

# Analysis

load libs
```{r, echo=FALSE}
library(ggplot2)
library(magrittr)
library(tidyverse)
library(dplyr)
```

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentYear) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = AccidentYear, y = Count, fill = AccidentYear)) +
  geom_bar(stat = "identity") + 
  labs(title = "Accidents per year",
       x = "Year",
       y = "Nr. of accidents")
  
```

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count, fill = AccidentMonth)) +
  geom_bar(stat = "identity") + 
  scale_x_discrete() +
  labs(title = "Most accidents happen in summer",
       x = "Month",
       y = "Nr. of accidents")
  
```
Maybe because tourists travel through switzerland in summer? have a look at accidents on main roads in summer

```{r }
unique(accidents_df$RoadType_en)
```

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth, RoadType_en) %>% 
  summarise(Count = n()) %>% 
  arrange(.,desc(Count)) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count)) +
  geom_bar(stat = "identity") +
  facet_wrap( ~ RoadType_en) +
  scale_x_discrete() +
  labs(title = "Accidents per road type during the year",
       x = "Month",
       y = "Nr. of accidents")
  
```

Analyse Weekdays/Hours

````{r heatmap_of_accidents, echo = FALSE}

accidents_df[,c("AccidentUID", "AccidentWeekDay", "AccidentHour")] %>%
  group_by(AccidentWeekDay, AccidentHour) %>% 
  summarise(Count = n()) %>% 
  ggplot(aes(x = AccidentHour, y = AccidentWeekDay, fill = Count)) +
    geom_raster() +
    labs(x = 'Weekday', y = "Hour", title = "Most Accidents happen on weekdays in the evening") +
    theme_minimal()

````

````{r map_of_accidents, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "RoadType_en")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````


````{r map_of_accidents, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentWeekDay")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = AccidentWeekDay %in% c("aw406", "aw407"))) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Day") +
    scale_color_discrete(labels=c('Weekday', 'Weekend')) +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

````{r map_of_accidents_pedestrians, echo = FALSE}
accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentInvolvingPedestrian")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, 
             y = AccidentLocation_CHLV95_N, 
             colour = AccidentInvolvingPedestrian)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Pedestrian") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

lorem ipsum

`````{r }
unique(accidents_df$AccidentWeekDay)


`````
Thanks, bye!