---
title: "Analysis"
author: "Mel Fioravanti & Pascal Albisser"
date: "2023-01-30"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
always_allow_html: yes
---

load libs

```{r, echo=FALSE}
library(ggplot2)
library(magrittr)
library(tidyverse)
library(knitr)
library(sf)
library(data.table)
```

# The datasets

## Accidents

Load the accidents dataset, already downloaded. 
Source: https://data.geo.admin.ch/ch.astra.unfaelle-personenschaeden_alle/

In order to establish whether there are external factors that influence the amount of car accidents in Switzerland, we analyze two data-sets: 
the first (accidents) provides us with data from 2011 to 2021, and it is comprised of various factors relating to each accident. 

Here we have the following: 

-accident location (given in N and E coordinates in separate columns,) -severity of the accident (with 3 degrees,) 
-day of the week, month, year, and hour of the day (but we do miss the day of the month,) 
-whether the accident involved a pedestrian, bike, and/or motorcycle, 
-the type of accident(e.g. head-on collision,) 
-the type of road on which the accident happened, 
-various information about the location and municipality (Canton, municipality code, etc.)

Since we are interested, among other things, in finding out if there is a correlation between traffic and the amount of accidents on any given day, we also have the traffic data-set, which we matched to the accidents one. 
This data-set contains information about the location of traffic detectors throughout Switzerland. For each accident, we found the closest traffic detector. The data-set contains the following information: 

-name of the detector, canton, and road name (e.g A1,)
- month and year of the traffic detection, 
-exact location of the detector, given in N E coordinates.

With this analysis, our aim is to give an overview of the traffic situation in Switzerland over the last decade and to identify interesting trends, in order to isolate the factors that can predict the probability of having a car accident, if any can be extrapolated from these data-sets. 

> Dargestellt werden alle polizeilich registrierten Strassenverkehrsunfälle mit Personenschaden der Schweiz seit 2011. Die Daten des Vorjahres werden jeweils ca. im März aktualisiert. 

```{r setup, echo=FALSE}

accidents_df <- data.frame(fread("data/RoadTrafficAccidentLocations.csv"))
kable(head(accidents_df))
```

## Traffic

- describe how data is obtained (automatically, by whom, etc.) **Mel, can you look that up? Only 2-3 sentences, maybe include a picture of the counting machines? just to give some background**
- Data is really messy - preperation in seperate file `traffic-preprocessing.R` - only load csv

The data on traffic by the **Federal Roads Office** (which is a count of the number of cars detected at each station in a given month) was quite messy, and all in separate yearly files with, each with different structure. Therefore, the data needed to be merged and cleaned so that it could be used for our analysis. Some of the preprocessing is done by hand, some of it in the file `./traffic-preprocessing.R`. Here we load our preprocessed dataset. 

````{r, echo=FALSE}

traffic <- read.csv("data/processed/traffic.csv")
traffic <- traffic %>% 
  filter(!is.na(traffic$LV95_E)) %>% 
  filter(str_detect(Strasse, "A"))
kable(head(traffic))

````

## Roads (Motorways)

For plotting and background checks we also load the street-network of Swiss motorways. This is a geodata-set which includes geographical locations of all national roads in Switzerland and corresponding attributes like name, etc.   
The `sf`-library allows to directly read from the `.gdb` file format. 

````{r, echo=FALSE}
national_roads_file <-
  "data/roads/ch.astra.nationalstrassenachsen.gdb"
st_layers(national_roads_file)

# read in geodata of national roads
national_roads_geodata <-
  st_read(national_roads_file, layer = "Stammachsen")

kable(head(national_roads_geodata))
````

## Municipalities
**same here. do we even need to write something up about it? I can do it once we talk about it and I know whats going on**

**I think we can drop the municipality stuff as we do not need it.**

````{r}

library(readxl)
municipalities <- read_excel("data/municipalities/be-t-00.04-agv-01.xlsx", 
    sheet = "GDE")

````

````{r, echo=FALSE}

accidents_df <- left_join(accidents_df, municipalities[,c("GDENR", "GDENAMK")], by = join_by("MunicipalityCode" == "GDENR"))

kable(head(accidents_df))

````

# Analysis

Let's start our journey from the big picture. How many car accidents have there been in the last decade? And of these, how many were fatal? The graph below answers these questions. While we could expect a rise in car accidents, we see that generally there is little to no difference from one year to the other, with the exception of 2020. As we know, this was the year in which the Covid-19 outbreak caused a lockdown, with a subsequent decrease in cars on the roads. This will be further discussed below. Despite a lower total for 2020, we can see that the amount of accidents with severe injuries remains in line with the other years. 
2011 holds the first place in both total count of accidents, and most accidents in each severity category. It would be interesting to investigate this phenomenon further to see whether there is any causality with external events, such as the implementation of a new traffic law or temperatures,or if it is casual. 
The safest year of the decade, bar 2020, was 2013, where all both the total count and the total of each severity category is the lowest.
Albeit small, there is a slight decrease in accidents with severe injuries over the last decade. 

**please change the order of the stacked stuff in order of severity, from least to most on top, thanks :0) ** - **maybe you need to rearrange colors now?**

## Overview Statistics

**not sure what you envisioned wrting here** - **exactly what you did above**

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentYear, AccidentSeverityCategory_en) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = AccidentYear, y = Count, fill = factor(AccidentSeverityCategory_en, levels = c("Accident with fatalities", "Accident with severe injuries", "Accident with light injuries")))) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Accidents per Year",
       subtitle = "2011-2021",
       x = "Year",
       y = "Nr. of accidents",
       fill = "Accident Severity") + 
  scale_y_continuous(breaks = seq(0, 20000, 1500)) +
  scale_x_continuous(breaks = seq(2011, 2021, 1)) +
  scale_fill_manual(values = c("black", "darkred", "sienna3"))
  
                     
  
```
Now let's dig deeper and look at the monthly data. The bar chart below shows the number of accident per each month of the year. It shows that the total number of accidents that happened in the last decade in the month of june is by far the highest, reaching almost 21000. 
On the other hand, the safest month to drive in Switzerland is February. 
While our initial hypothesis was the winter months would be the ones with the most accidents due to icy roads, it appears that ice and snow do not constitute a reason for the Swiss to drive less safely. 
However, with the start of summer and the touristic season, the number of accidents increases dramatically, suggesting that one of the causes of the increase could be the higher number of cars on the road. 
To stay safe, it is probably best to use trains and public transport during the summer months, and rely on the automobile during the off-season months. 

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count, fill = Count)) +
  geom_bar(stat = "identity") + 
  scale_fill_gradient(low = "palegreen4", high = "darkred") +
  scale_x_discrete() +
  labs(title = "Number of Accidents per Month",
       subtitle = "Most Accidents happen in the summer",
       x = "Month",
       y = "Nr. of accidents") +
  geom_text(aes(label = ifelse(Count == max(Count),     as.character(Count), "")),
            vjust = -0.5, color = "darkred", size = 3)+
  scale_x_discrete( labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) +
  scale_y_continuous(breaks = seq(0, 21000, 3000))
 
  
```

## Correlation traffic - accidents

In our analysis, we want to know whether there is a correlation between cars on the road and amount of accidents. We therefore look at the measurements of traffic across months from the year 2018 to 2021.
The first thig that draws our attention is that the median drops significantly in April of 2020, when the lockdown happened. However, we see that after that the values are back to average,following the trend of being less in the winter, and rising up again as the summer approaches. 

We would, however, expect to see a spike in traffic during the month of June, or at least the summer months in general. 
Based on this graph, we do see a small spike in the median of the amount of traffic, but it is difficult to tell whether the spike could be causing the higher amount of accidents or not. We therefore need to perform a statistical analysis to confirm or reject our thesis. 
  
**question, hope it isnt stupid. Why are we looking at total number of accidents vs median of traffic? to draw a comparison, shouldnt we look at total number and then  a percentage or something? again, sorry if it doestn make sense.** - **I would argue that this is just a very general visual overview to get a first impression. So the unit does not really matter, its just ups and downs - the statistical model is what we do below right?**

**I would still put the following chapter either before or after, but it really doesn't matter.** 


````{r, echo = FALSE} 

traffic %>% 
  group_by(No) %>% 
  mutate(count_norm = Count / max(Count, na.rm = TRUE))  %>% 
  group_by(Month, Year) %>% 
  summarise(
    mean_traffic = mean(x = count_norm, na.rm = TRUE), 
    median_traffic = median(x = count_norm, na.rm = TRUE), 
    lower = quantile(x = count_norm, na.rm = TRUE, probs = c(0.25)), 
    upper = quantile(x = count_norm, na.rm = TRUE, probs = c(0.75))
  ) %>% 
  mutate(Year = factor(Year)) %>% 
  ggplot(mapping = aes(x = Month, y = median_traffic, group = Year, color = Year)) +
    geom_point() +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1) +
    labs(title = "Median of Normalized Traffic", 
         subtitle = "2018-2021",
         y = "Median",
         x = "Month") +
   scale_x_continuous( labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), 
                      breaks = seq(1,12,1)) + 
  scale_y_continuous(breaks = seq(0, 1, 0.2))


````

### Spatial Joins - Chapter of choice

So far we compared amount of traffic to number of accidents on a very general level. But what if we wanted to look at this relationship on a more granular level? As we have the exact location of each accident and each traffic measurement we should be able to do this for each street/sector. But in order to do so we need to have a corresponding measurement of traffic for each accident, but as of now there is no link between them.
  
This is where the `sf`-package comes into play. SF stands for [https://en.wikipedia.org/wiki/Simple_Features](simple features) and it comes with a lot of functions to deal with geo-spatial data. The package itself was mentioned in the course to plot maps. Here, we will use it to find the shortest distance between two geo-spatial points so that we can join the two data-sets at said points.
This is done as follows:
    
To make things easier for us we first convert the given traffic data into a geodata-frame. With the function `st_as_sf()` each line is transferred into a simple feature with the specified coordinates. As both datasets are in the [https://www.swisstopo.admin.ch/en/knowledge-facts/surveying-geodesy/reference-frames/local/lv95.html](swiss LV95) georeference system we do not need to worry about specifying or converting the coordinates at this point.

````{r}
traffic_as_sf <- st_as_sf(
  traffic[!is.na(traffic$LV95_E), ],
  coords = c("LV95_E", "LV95_N")
)

````

As most traffic counters are located on motorways, we filter our accident data by road type and the years for which we have the traffic data (2018-2021.)

````{r}

accidents_motorways <- accidents_df %>%
  filter(RoadType_en == "Motorway") %>% 
  filter(AccidentYear > 2017)
````

The accidents on motorways during the given year make up roughly 3% of all accidents. This is a small subset of the accidents, but it can still give us some interesting insights for a model.

````{r}

nrow(accidents_motorways) / nrow(accidents_df)

````

As we did for the traffic data, we also convert our accident data into simple features with the given coordinates. Note: these are also in Swiss LV95.

````{r}

accidents_as_sf <-
  st_as_sf(
    accidents_motorways,
    coords = c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N")
  )

````

Now we want to know on which road and segment a given accident happened. Given only the coordinates of both and no further information, we utilize a function called `st_nearest_feature(x, y)`. This returns the index of the nearest feature in `y` (in our case the national roads) for every given feature in `x` (the accidents.)

For example: The accident given on the following map (black dot) should map to the street segment WANKDORF - LIMMATTAL of the selected motorway N1. 

````{r}

ggplot() + 
  geom_sf(data = accidents_as_sf[5, ]) +
  geom_sf(data = national_roads_geodata[national_roads_geodata$Strassennummer == "N1",], mapping = aes(color = Segmentname)) +
  labs(title = "Accident #5 on motorway N1", x = "East", y = "North")

````
This is confirmed by the following code:


````{r}

idx = st_nearest_feature(accidents_as_sf[5, ], national_roads_geodata)
national_roads_geodata[idx,c("Segmentname")]

````
As we have seen,  the function works as expected we can apply this to all accidents and add the respective columns to the accidents data-set.

````{r}

# get index of nearest road/segment for every accident
idx <- st_nearest_feature(accidents_as_sf, national_roads_geodata)

# add road name and segment as a column to accidents
accidents_as_sf$road <-
  as.data.frame(national_roads_geodata)[idx, "Strassennummer"]
accidents_as_sf$road_segment <-
  as.data.frame(national_roads_geodata)[idx, "Segmentname"]

````

As a second step, we want to find the nearest traffic counter. This allows us to approximate the amount of traffic at the given accident location during the given time period (month/year.) We apply the same procedure as above, but now finding the nearest point in the traffic data-set. Again, we pick the same accident as before (black dot) and its nearest traffic counters (red:)

````{r}

ggplot() + 
  geom_sf(data = traffic_as_sf[traffic_as_sf$Strasse == "A1" & traffic_as_sf$Canton == "BE",], mapping = aes(color = Canton)) +
  geom_sf_text(data = traffic_as_sf[traffic_as_sf$Strasse == "A1" & traffic_as_sf$Canton == "BE",], mapping = aes(label = No), nudge_x = -2000, nudge_y = 1000) +
  geom_sf(data = accidents_as_sf[5, ]) +
  labs(title = "Accident #5 and nearby traffic counters", x = "East", y = "North")
  
````
  
We can further confirm this by using this method. 

````{r}

idx = st_nearest_feature(accidents_as_sf[5, ], traffic_as_sf)
traffic_as_sf[idx,c("No")]

````

Once we are sure that the results are accurate, we apply the procedure to the whole data-set.

````{r}

# get index of nearest traffic counter for every accident
idx <- st_nearest_feature(accidents_as_sf, traffic_as_sf)

# match accidents with nearest traffic counter id
accidents_as_sf$nearestCounter <-
  as.data.frame(traffic_as_sf)[idx, "No"]

````

To check our results we plot all our accidents on an interactive map and visualize the joins by color. The result seems to be accurate and we can move forward.

**here we need to find a better marker probably. I've played around with it and landed on these small squares for now.I cant really see the dots still so it needs to change, but not sure how to isolate the dots?** - **maybe play with sizes & alpha (opacity)? **

````{r , echo=FALSE}


plt <- ggplot() +
  geom_sf(data = accidents_as_sf,
          mapping = aes(colour = nearestCounter)) +
  scale_color_gradientn(colours = rainbow(3)) +
  geom_sf(data = traffic_as_sf,
          mapping = aes(colour = No), shape = 18, size = 2) +
  labs(title = "Check mapping of accidents (dots) & counters (cross)",
       ) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) + 
  xlab("S") + 
  ylab("W")

plotly::ggplotly(plt)

````

## Modelling Traffic vs. Accidents

In order to model/group accidents by month/year, we match them with the respective traffic data:

```{r , echo=FALSE}

motorway_accidents_per_month <- as.data.frame(accidents_as_sf) %>% 
  group_by(nearestCounter, AccidentMonth, AccidentYear) %>% 
  summarise(NrAccidents = n())

# work here
model_data <- left_join(motorway_accidents_per_month, traffic, by = join_by(nearestCounter == No, AccidentMonth == Month, AccidentYear == Year))

model_data <- as.data.frame(model_data) %>% 
  rename(
    "Year" = "AccidentYear",
    "Month" = "AccidentMonth",
    "NumberOfAccidents" = "NrAccidents",
    "AvgTrafficPerDay" = "Count"
  ) %>% 
  select(c("NumberOfAccidents", "AvgTrafficPerDay", "Month", "Year")) %>% 
  arrange(Year, Month)

```

**I would LOVE to know what is wrong in my code for cor(). not that I need it, but It would have been nice to have the cor** 

```{r , echo=FALSE}

# ggplot(data = model_data,
#              mapping = aes(
#                x = NumberOfAccidents, 
#                y = AvgTrafficPerDay,
#                color = Month %in% c(6,7,8)
#               )) +
#   geom_point() +
#   geom_jitter(width = .2) +
#   scale_color_discrete(labels=c('Rest of the Year', 'Summer')) +
#   labs(colour = "Month", title = "Number of Accidents vs. Amount of Traffic (per Day)", subtitle = "2018-2021") +
#   xlab("Number of Accidents") +
#   ylab("Average Cars per Day")  

ggplot(data = model_data,
             mapping = aes(
               x = AvgTrafficPerDay,
               y = NumberOfAccidents
              )) +
  geom_point() +
  geom_jitter(width = .2) +
  labs(title = "Number of Accidents vs. Amount of Traffic (per Day)",    subtitle = "2018-2021") +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) +
  xlab("Number of Cars Detected") +
  ylab("Number of Accidents") 
  
cor(model_data$AvgTrafficPerDay, model_data$NumberOfAccidents)
 
```

##The Regression Model 

To test our hypothesis that a larger number of cars leads to a higher number of accidents we perform a regression model. As we can see from the graph above, the regression line seems to show a positive correlation.
Our null hypothesis (H0) is that there is no significant relationship between the amount of cars and the number of accidents, while our alternative hypothesis (H1) is that there is a significant relationship between the two variables. 

Let's look at the output of the regression model and see what the numbers tell us.


```{r}
traffic_accident_model <- lm(NumberOfAccidents ~ AvgTrafficPerDay, data = model_data )
summary(traffic_accident_model)
```
The _Residuals_ section shows the minimum, first quartile, median, third quartile, and maximum values of the model residuals. Residuals are the differences between the actual values and the predicted values from the model. This gives us an idea of the variability of the model error.

The _Coefficients_ table shows the estimated regression coefficients for the intercept and the predictor variable AvgTrafficPerDay. The intercept is the predicted value of the response variable when the amount of cars detected  is equal to zero, and the coefficient of the estimate for **AvgTrafficPerDay** is the estimated change in the response variable for a one-unit increase in the predictor variable. Both coefficients are statistically significant because the p-values are well below the significance level of 0.05, which means we can reject H0.


The _Residual standard error_ tells us that the model fits the data, because it is low. 


The _Multiple R-squared_ refers to the percentage of variance explained by the mode. In this case, the predictor variable is **AvgTrafficPerDay**, and the R-squared value of 0.09221 indicates that only 9.2% of the variance in the response variable is explained by traffic.

A larger _F-statistic_ and smaller _p-value_ indicate that the model is a good fit for the data. In this case, the F-statistic is 252.5 with a very small p-value (very close to 0), which indicates that the model is statistically significant.

Overall, this model shows that there is a significant positive relationship between the , but the model explains only a small proportion of theamount of cars detected and the amount of accidents recorded, however, only a small portion of this is explained by this model. 

Overall, it is clear that there is a relationship between traffic and amount of accidents, but there appear to be more variables that have an impact on accidents, and therefore a deeper analysis is required to understand when and where it is safer to drive in Switzerland. 


## Rush Hour Accidents

After analyzing traffic in relation to years and months, we now take a deeper look at what an average day looks like. That is, we answer the questions:
-"During what times are there more accidents?" 
-"Are there more accidents on any given day of the week?" 

The following heatmap answers the questions in a very straightforward manner. If we look at the lighter areas, which correspond to the times with the most accidents, we can identify two main time zones during the work week (Monday through Friday:) 
- between _6A.M. and 8A.M_
- between _4P.M and 6P.M._ 

During the weekend (Saturday and Sunday,) there isn't a clear time frame in which more accidents happen, but they are mainly happening in the late morning to mid afternoon.

This shows us that most accidents happen when people are on their way to and from work, being that the formerly identified time frames coincide quite accurately with the limits of the workday in Switzerland. On the other hand, during the weekend it is clear that people tend to leave the house either later or not all in bulk as they do during the week, therefore making it difficult to find a clear pattern. However, compared to weekdays, there are more accidents from midnight to 5A.M. on the weekend, something that already starts on Friday after work. 


````{r heatmap_of_accidents, echo = FALSE}

accidents_df[,c("AccidentUID", "AccidentWeekDay", "AccidentHour")] %>%
  group_by(AccidentWeekDay, AccidentHour) %>% 
  summarise(Count = n()) %>% 
  mutate(AccidentWeekDay_f=factor(x = AccidentWeekDay,levels = rev(c("aw401", "aw402", "aw403", "aw404", "aw405", "aw406", "aw407"
)), labels = rev(c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))) %>% 
  # pull(AccidentWeekDay_f) %>% levels() %>% dput
  ggplot(aes(x = AccidentHour, y = AccidentWeekDay_f, fill = Count)) +
    geom_raster() +
    labs(x = 'Hour', y = "Day", title = "Distribution of Accidents during the Day") +
    theme_minimal() +
  scale_x_continuous(breaks = seq(0,24,1)) + 
  scale_fill_gradient(low= "pink1", high= "darkred")

````

## Zurich - the most dangerous Municipality (in absolute numbers)

poor zurich 

`````{r }

library(knitr)

accidents_df %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Most dangerous municipalites")
`````

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

````{r map_of_accidents_by_in_zh, echo = FALSE}

accidents_df %>%
  filter(MunicipalityCode == 261) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents in ZH") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed() + 
    labs(colour = "Type of road")

````

# Conclusion

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.  
  
  
Thanks, bye!
<hr />

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth, RoadType_en) %>% 
  summarise(Count = n()) %>% 
  arrange(.,desc(Count)) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count)) +
  geom_bar(stat = "identity") +
  facet_wrap( ~ RoadType_en) +
  scale_x_discrete() +
  labs(title = "Accidents per road type during the year",
       x = "Month",
       y = "Nr. of accidents")
  
```

````{r map_of_accidents_by_road_type, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "RoadType_en")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````


````{r map_of_accidents, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentWeekDay")] %>%
  mutate(Weekend = AccidentWeekDay %in% c("aw406", "aw407")) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = Weekend)) +
    geom_point(alpha = 0.01) +
    facet_wrap(~Weekend) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Day") +
    scale_color_discrete(labels=c('Weekday', 'Weekend')) +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

````{r map_of_accidents_pedestrians, echo = FALSE}
accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentInvolvingPedestrian")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, 
             y = AccidentLocation_CHLV95_N, 
             colour = AccidentInvolvingPedestrian)) +
    geom_point(alpha = 0.1) +
    facet_wrap( ~AccidentInvolvingPedestrian, nrow = 2) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Pedestrian") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````



`````{r }


accidents_df %>% 
  filter(AccidentSeverityCategory == "as1") %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Municipalities with most fatalities in accidents")
`````


````{r map_of_fata_accidents_by_road_type, echo = FALSE}

map_acc <- accidents_df %>%
  filter(AccidentSeverityCategory == "as1") %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, label = GDENAMK, color = RoadType_en)) +
    geom_point(alpha = 0.2) +
    labs(x = 'E', y = "N", title = "Map of Fatal Accidents") +
    theme_minimal() +
    coord_fixed()

plotly::ggplotly(map_acc)

````
**I dislike this map above, I think we can get rid of it. if you agree, feel free to remove it**


```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = AccidentSeverityCategory_en)) +
  geom_bar() +
  facet_wrap(~ AccidentSeverityCategory_en, scales = "free") +
  labs(x = "Number of accidents")  

```
**this graph can go in the main text as well**

```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = RoadType_en)) +
  geom_bar() +
  facet_wrap(~ RoadType_en) +
  labs(x = "Number of accidents")  

```

```{r}

# model <- lm(factor(AccidentSeverityCategory) ~ AccidentHour, data = accidents_df[,!is.na("AccidentSeverityCategory")])
# summary(model)

model_data <- accidents_df %>% 
  group_by(AccidentSeverityCategory_en, AccidentHour) %>% 
  summarise(count = n()) %>% 
  mutate(severity = factor(AccidentSeverityCategory_en))

ggplot(data = model_data, mapping = aes(x = AccidentHour, y = count, group_by = severity)) +
  geom_line()


```
````{r}

unique(accidents_df$AccidentType_en)
ggplot(data = accidents_df) +
  geom_bar(mapping = aes(x = AccidentType_en, fill = AccidentType_en )) +
  theme(axis.text.x = element_text(face="bold", color="#993333", 
                           size=5, angle=45), legend.position = "none") +
  scale_x_discrete(name = "Accident Type") +
  scale_y_continuous(name = " Number of Accidents")
  #facet_wrap(~RoadType_en, ncol = 2)

````
**here I will write something about the graph above cuz its pretty and we need stuff**

````{r, echo = FALSE}

library(ggridges)

accidents_df %>% mutate(AccidentWeekDay_f=factor(x = AccidentWeekDay,levels = rev(c("aw401", "aw402", "aw403", "aw404", "aw405", "aw406", "aw407"
)), labels = rev(c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))) %>% 
  ggplot() +
    geom_density_ridges(mapping = aes(x = AccidentHour, y = AccidentWeekDay_f, fill = AccidentWeekDay_f)) +
    theme(legend.position = "none") + 
    labs(title = "Most accidents happen on weekdays after work", y = "Day of accident", x = "Hour of accident")
````
**this would be cool to have close to the heatmap**
