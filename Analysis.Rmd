---
title: "Analysis"
author: "Mel Fioravanti & Pascal Albisser"
date: "2023-01-30"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
always_allow_html: yes
---

load libs

```{r, echo=FALSE}
library(ggplot2)
library(magrittr)
library(tidyverse)
library(knitr)
library(sf)
library(data.table)
```

# The datasets

## Accidents

Load the accidents dataset, already downloaded. 
Source: https://data.geo.admin.ch/ch.astra.unfaelle-personenschaeden_alle/

> Dargestellt werden alle polizeilich registrierten Strassenverkehrsunfälle mit Personenschaden der Schweiz seit 2011. Die Daten des Vorjahres werden jeweils ca. im März aktualisiert. 

```{r setup, echo=FALSE}

accidents_df <- data.frame(fread("data/RoadTrafficAccidentLocations.csv"))
kable(head(accidents_df))
```

## Traffic

- describe how data is obtained (automatically, by whom, etc.)
- Data is really messy - preperation in seperate file `traffic-preprocessing.R` - only load csv
- https://www.astra.admin.ch/astra/de/home/dokumentation/daten-informationsprodukte/verkehrsdaten/daten-publikationen/automatische-strassenverkehrszaehlung/monats-jahresergebnisse.html


````{r, echo=FALSE}

traffic <- read.csv("data/processed/traffic.csv")
traffic <- traffic %>% 
  filter(!is.na(traffic$LV95_E)) %>% 
  filter(str_detect(Strasse, "A"))
kable(head(traffic))

````

## Roads (Motorways)

````{r, echo=FALSE}
national_roads_file <-
  "data/roads/ch.astra.nationalstrassenachsen.gdb"
st_layers(national_roads_file)

# read in geodata of national roads
national_roads_geodata <-
  st_read(national_roads_file, layer = "Stammachsen")

kable(head(national_roads_geodata))
````

## Municipalities

````{r}

library(readxl)
municipalities <- read_excel("data/municipalities/be-t-00.04-agv-01.xlsx", 
    sheet = "GDE")

````

````{r, echo=FALSE}

accidents_df <- left_join(accidents_df, municipalities[,c("GDENR", "GDENAMK")], by = join_by("MunicipalityCode" == "GDENR"))

kable(head(accidents_df))

````

# Analysis

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

## Overview Statistics

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.


```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentYear, AccidentSeverityCategory_en) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = AccidentYear, y = Count, fill = AccidentSeverityCategory_en)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Accidents per year",
       x = "Year",
       y = "Nr. of accidents",
       fill = "Accident Severity")
  
```
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count, fill = Count)) +
  geom_bar(stat = "identity") + 
  scale_fill_continuous(type = "gradient", trans = "reverse") +
  scale_x_discrete() +
  labs(title = "Most accidents happen in the summer",
       x = "Month",
       y = "Nr. of accidents")
  
```

## Correlation traffic - accidents

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
  
2020 should not really be considered (pandemic)

````{r, echo = FALSE} 

traffic %>% 
  group_by(No) %>% 
  mutate(count_norm = Count / max(Count, na.rm = TRUE))  %>% 
  group_by(Month, Year) %>% 
  summarise(
    mean_traffic = mean(x = count_norm, na.rm = TRUE), 
    median_traffic = median(x = count_norm, na.rm = TRUE), 
    lower = quantile(x = count_norm, na.rm = TRUE, probs = c(0.25)), 
    upper = quantile(x = count_norm, na.rm = TRUE, probs = c(0.75))
  ) %>% 
  mutate(Year = factor(Year)) %>% 
  ggplot(mapping = aes(x = Month, y = median_traffic, group = Year, color = Year)) +
    geom_point() +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1) +
    labs(title = "Median of normalized traffic, 2018 - 2021")


````

### Spatial Joins - Chapter of choice

So far we have only compared traffic and number of accidents on a very high level. What if we wanted to look at this relationship on a more granular level? As we have the exact location of each accident and each traffic measurement we should be able to do this per street/sector. But in order to do so we need to somehow find a corresponding traffic measurement for each accident as there is no link between them as of now.
  
This is where the `sf`-package drops in. SF stands for [https://en.wikipedia.org/wiki/Simple_Features](simple features) and comes with a lot of functions to deal with geospatial data. The package itself was already mentioned in the course to plot maps. We will use it here to find the shortest distence between two geospatial points to join the two datasets. This is done in the following steps:
    
To make things easier for us we first convert the given traffic data into a geodata-frame. With the function `st_as_sf()` each line is transferred into a simple feature with the specified coordinates. As both datasets are in the [https://www.swisstopo.admin.ch/en/knowledge-facts/surveying-geodesy/reference-frames/local/lv95.html](swiss LV95) georeference system we do not need to worry about specifying or converting the coordinates at this point.

````{r}
traffic_as_sf <- st_as_sf(
  traffic[!is.na(traffic$LV95_E), ],
  coords = c("LV95_E", "LV95_N")
)

````

As most traffic counters are located on motorways we filter our accident data on roadtype and the given years for which we hold traffic data (2018-2021).

````{r}

accidents_motorways <- accidents_df %>%
  filter(RoadType_en == "Motorway") %>% 
  filter(AccidentYear > 2017)
````

The accidents on motorways during the given year make roughly 3% of all accidents. This is a small subset of the accidents but still some points to model.

````{r}

nrow(accidents_motorways) / nrow(accidents_df)

````

As before with the traffic data we also convert our traffic data into simple features with the given coordinates. Note: these are also in swiss LV95.

````{r}

accidents_as_sf <-
  st_as_sf(
    accidents_motorways,
    coords = c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N")
  )

````

Now we want to know on which road and segment a given accident happened. Given only the coordinates of both sides and no further information we utilize a function called `st_nearest_feature(x, y)`. It returns the index of the nearest feature in `y` (in our case the national roads) for every given feature in `x` (the accidents).

For example: The one accident given on the following map (black dot) should map to the street segment WANKDORF - LIMMATTAL of the selected motorway N1. 

````{r}

ggplot() + 
  geom_sf(data = accidents_as_sf[5, ]) +
  geom_sf(data = national_roads_geodata[national_roads_geodata$Strassennummer == "N1",], mapping = aes(color = Segmentname)) +
  labs(title = "Accident #5 on motorway N1", x = "East", y = "North")

````
This is confirmed by the following code:
````{r}

idx = st_nearest_feature(accidents_as_sf[5, ], national_roads_geodata)
national_roads_geodata[idx,c("Segmentname")]

````
As we now have acknowledged the function works as expected we can do this for all accidents and add the respectice columns to the accidents dataset.

````{r}

# get index of nearest road/segment for every accident
idx <- st_nearest_feature(accidents_as_sf, national_roads_geodata)

# add road name and segment as a column to accidents
accidents_as_sf$road <-
  as.data.frame(national_roads_geodata)[idx, "Strassennummer"]
accidents_as_sf$road_segment <-
  as.data.frame(national_roads_geodata)[idx, "Segmentname"]

````

As a second step we want to find the nearest traffic counter. This allows us to approximate the traffic at the given accident location during the given month/year. We apply the same procedure as above, but now finding the nearest point in the traffic dataset. But first let us pick the same accident before (black dot) and its nearest traffic counters (red):

````{r}

ggplot() + 
  geom_sf(data = traffic_as_sf[traffic_as_sf$Strasse == "A1" & traffic_as_sf$Canton == "BE",], mapping = aes(color = Canton)) +
  geom_sf_text(data = traffic_as_sf[traffic_as_sf$Strasse == "A1" & traffic_as_sf$Canton == "BE",], mapping = aes(label = No), nudge_x = -2000, nudge_y = 1000) +
  geom_sf(data = accidents_as_sf[5, ]) +
  labs(title = "Accident #5 and nearby traffic counters", x = "East", y = "North")
  
````
  
This is confirmed also confirmed by a little check. 
````{r}

idx = st_nearest_feature(accidents_as_sf[5, ], traffic_as_sf)
traffic_as_sf[idx,c("No")]

````

After acknowledging it is working properly we apply the procedure to the whole data.

````{r}

# get index of nearest traffic counter for every accident
idx <- st_nearest_feature(accidents_as_sf, traffic_as_sf)

# match accidents with nearest traffic counter id
accidents_as_sf$nearestCounter <-
  as.data.frame(traffic_as_sf)[idx, "No"]

````

To check our results we plot all our accidents on an interactive map and visualize the joins by colour. The result seems to be accurate and allows us to go on. 

````{r , echo=FALSE}
plt <- ggplot() +
  geom_sf(data = accidents_as_sf,
          mapping = aes(colour = nearestCounter)) +
  scale_color_gradientn(colours = rainbow(3)) +
  geom_sf(data = traffic_as_sf,
          mapping = aes(colour = No), shape = 13, size = 6) +
  labs(title = "Check mapping of accidents (dots) & counters (cross)")

plotly::ggplotly(plt)

````

## Modelling Traffic vs. Accidents

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

In order to model, group accidents by month/year and match with respective traffic data
```{r , echo=FALSE}

motorway_accidents_per_month <- as.data.frame(accidents_as_sf) %>% 
  group_by(nearestCounter, AccidentMonth, AccidentYear) %>% 
  summarise(NrAccidents = n())

# work here
model_data <- left_join(motorway_accidents_per_month, traffic, by = join_by(nearestCounter == No, AccidentMonth == Month, AccidentYear == Year))

model_data <- as.data.frame(model_data) %>% 
  rename(
    "Year" = "AccidentYear",
    "Month" = "AccidentMonth",
    "NumberOfAccidents" = "NrAccidents",
    "AvgTrafficPerDay" = "Count"
  ) %>% 
  select(c("NumberOfAccidents", "AvgTrafficPerDay", "Month", "Year")) %>% 
  arrange(Year, Month)

```

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

```{r , echo=FALSE}

ggplot(data = model_data,
             mapping = aes(
               x = NumberOfAccidents, 
               y = AvgTrafficPerDay,
               color = Month %in% c(6,7,8)
              )) +
  geom_point() +
  geom_jitter(width = .2) +
  scale_color_discrete(labels=c('Others', 'Summer')) +
  labs(colour = "Month", title = "Number of Accidents vs. Amount of Traffic, 2018 - 2021")

```

## Rush Hour Accidents

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

````{r heatmap_of_accidents, echo = FALSE}

accidents_df[,c("AccidentUID", "AccidentWeekDay", "AccidentHour")] %>%
  group_by(AccidentWeekDay, AccidentHour) %>% 
  summarise(Count = n()) %>% 
  mutate(AccidentWeekDay_f=factor(x = AccidentWeekDay,levels = rev(c("aw401", "aw402", "aw403", "aw404", "aw405", "aw406", "aw407"
)), labels = rev(c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))) %>% 
  # pull(AccidentWeekDay_f) %>% levels() %>% dput
  ggplot(aes(x = AccidentHour, y = AccidentWeekDay_f, fill = Count)) +
    geom_raster() +
    labs(x = 'Hour', y = "Day of  the Week", title = "Most Accidents happen on weekdays in the evening") +
    theme_minimal()

````

## Zurich - the most dangerous Municipality (in absolute numbers)

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

`````{r }

library(knitr)

accidents_df %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Most dangerous municipalites")
`````

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

````{r map_of_accidents_by_in_zh, echo = FALSE}

accidents_df %>%
  filter(MunicipalityCode == 261) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents in ZH") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed() + 
    labs(colour = "Type of road")

````

# Conclusion

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.  
  
  
Thanks, bye!
<hr />

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth, RoadType_en) %>% 
  summarise(Count = n()) %>% 
  arrange(.,desc(Count)) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count)) +
  geom_bar(stat = "identity") +
  facet_wrap( ~ RoadType_en) +
  scale_x_discrete() +
  labs(title = "Accidents per road type during the year",
       x = "Month",
       y = "Nr. of accidents")
  
```

````{r map_of_accidents_by_road_type, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "RoadType_en")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````


````{r map_of_accidents, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentWeekDay")] %>%
  mutate(Weekend = AccidentWeekDay %in% c("aw406", "aw407")) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = Weekend)) +
    geom_point(alpha = 0.01) +
    facet_wrap(~Weekend) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Day") +
    scale_color_discrete(labels=c('Weekday', 'Weekend')) +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

````{r map_of_accidents_pedestrians, echo = FALSE}
accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentInvolvingPedestrian")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, 
             y = AccidentLocation_CHLV95_N, 
             colour = AccidentInvolvingPedestrian)) +
    geom_point(alpha = 0.1) +
    facet_wrap( ~AccidentInvolvingPedestrian, nrow = 2) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Pedestrian") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````



`````{r }


accidents_df %>% 
  filter(AccidentSeverityCategory == "as1") %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Municipalities with most fatalities in accidents")
`````


````{r map_of_fata_accidents_by_road_type, echo = FALSE}

map_acc <- accidents_df %>%
  filter(AccidentSeverityCategory == "as1") %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, label = GDENAMK, color = RoadType_en)) +
    geom_point(alpha = 1) +
    labs(x = 'E', y = "N", title = "Map of fatal accidents") +
    theme_minimal() +
    coord_fixed()

plotly::ggplotly(map_acc)

````


```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = AccidentSeverityCategory_en)) +
  geom_bar() +
  facet_wrap(~ AccidentSeverityCategory_en, scales = "free") +
  labs(x = "Number of accidents")  

```

```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = RoadType_en)) +
  geom_bar() +
  facet_wrap(~ RoadType_en) +
  labs(x = "Number of accidents")  

```

```{r}

# model <- lm(factor(AccidentSeverityCategory) ~ AccidentHour, data = accidents_df[,!is.na("AccidentSeverityCategory")])
# summary(model)

model_data <- accidents_df %>% 
  group_by(AccidentSeverityCategory_en, AccidentHour) %>% 
  summarise(count = n()) %>% 
  mutate(severity = factor(AccidentSeverityCategory_en))

ggplot(data = model_data, mapping = aes(x = AccidentHour, y = count, group_by = severity)) +
  geom_line()


```
````{r}

unique(accidents_df$AccidentType_de)

ggplot(data = accidents_df) +
  geom_bar(mapping = aes(x = AccidentType_de, fill = AccidentType_de)) +
  facet_wrap(~RoadType_en, ncol = 2)

````

````{r, echo = FALSE}

library(ggridges)

accidents_df %>% mutate(AccidentWeekDay_f=factor(x = AccidentWeekDay,levels = rev(c("aw401", "aw402", "aw403", "aw404", "aw405", "aw406", "aw407"
)), labels = rev(c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))) %>% 
  ggplot() +
    geom_density_ridges(mapping = aes(x = AccidentHour, y = AccidentWeekDay_f, fill = AccidentWeekDay_f)) +
    theme(legend.position = "none") + 
    labs(title = "Most accidents happen on weekdays after work", y = "Day of accident", x = "Hour of accident")
````
