---
title: "Analysis"
author: ""
output: html_document
date: "2023-01-30"
---

# Loading the datasets

load libs

```{r, echo=FALSE}
library(ggplot2)
library(magrittr)
library(tidyverse)
```

## accidents

Load the accidents dataset, already downloaded. 
Source: https://data.geo.admin.ch/ch.astra.unfaelle-personenschaeden_alle/

> Dargestellt werden alle polizeilich registrierten Strassenverkehrsunfälle mit Personenschaden der Schweiz seit 2011. Die Daten des Vorjahres werden jeweils ca. im März aktualisiert. 

```{r setup}
library(data.table)

accidents_df <- data.frame(fread("data/RoadTrafficAccidentLocations.csv"))
columns <- c("AccidentUID", "AccidentType", "AccidentType_en", "AccidentSeverityCategory", "AccidentSeverityCategory_en", "AccidentInvolvingPedestrian", "AccidentInvolvingBicycle", "AccidentInvolvingMotorcycle", "RoadType", "RoadType_en", "AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "CantonCode", "MunicipalityCode", "AccidentYear", "AccidentMonth", "AccidentWeekDay", "AccidentHour", "AccidentWeekDay_en")
accidents_df <- accidents_df[columns]
head(accidents_df)
```

## Traffic

- describe how data is obtained (automatically, by whom, etc.)
- https://www.astra.admin.ch/astra/de/home/dokumentation/daten-informationsprodukte/verkehrsdaten/daten-publikationen/automatische-strassenverkehrszaehlung/monats-jahresergebnisse.html


````{r}

base_url <- "https://www.astra.admin.ch/dam/astra/de/dokumente/verkehrsdaten/2021/jahresergebnisse.xlsx.download.xlsx/Jahresergebnisse%202021.xlsx"

"https://www.astra.admin.ch/dam/astra/de/dokumente/verkehrsdaten/2020/jahresergebnisse-20.xlsx.download.xlsx/Bulletin_2020_12_de.xlsx"

"https://www.astra.admin.ch/dam/astra/de/dokumente/verkehrsdaten/2019/jahresergebnisse_2019.xlsx.download.xlsx/Bulletin_2019_de.xlsx"


````

````{r}

# use openxlsx in order to fill merged cells

library(openxlsx)

traffic_data <- read.xlsx(xlsxFile = "data/traffic/Jahresergebnisse 2021.xlsx", fillMergedCells = TRUE, startRow = 7, sheet = "DTV", check.names = TRUE)
traffic_data <- subset(traffic_data, select = -c(Messstelle.1)) 
traffic_data <- traffic_data %>% 
  rename("Messvariable" = "X6") %>% 
  rename("Total" = "X2021") %>% 
  mutate(No = strtoi(No))

head(traffic_data)

````

````{r}


traffic_data <- traffic_data %>% 
  filter(Messvariable == "DTV") %>% 
  pivot_longer(cols = matches("X[0-9]{2}$"), names_to = "month", values_to = "count") #%>% 
  # ggplot(mapping = aes(x = month, y = count, group_by = Messstelle)) +
  #   facet_wrap( ~ Messstelle) + 
  #   geom_point()

head(traffic_data)
````

### stations of traffic counters

````{r}

library(readxl)
traffic_counters <- read_excel("data/traffic_counters/messstellenverzeichnis.xlsx", 
    sheet = "SASVZ_CSACR", skip = 10)

# rename
traffic_counters <- traffic_counters %>% 
  rename("No" = "Nummer\r\nNuméro\r\nNuméro",
         "LV95_E" = "Koordinate Ost LV95\r\nCoordonnée est LV95\r\nCoordinata est LV95",
         "LV95_N" = "Koordinate Nord LV95\r\nCoordonnée nord LV95\r\nCoordinata nord LV95") %>% 
  select(c("No", "LV95_E", "LV95_N"))
head(traffic_counters)
````

visualize

````{r}

ggplot(data = traffic_counters, mapping = aes(x = LV95_E, y = LV95_N)) +
  geom_point() + 
  labs(title = "Map of traffic counters")

````
### merge location data with traffic counter measurements

````{r}

traffic <- left_join(traffic_data, traffic_counters, by = "No")

head(traffic)

````


## Roads Geodata

````{r}

# library(rgdal)
# 
# file <- "data/2021_SWISSTLM3D_FGDB101_CHLV95_LN02/SWISSTLM3D_2021_LV95_LN02.gdb"
# ogrListLayers(file)
# 
# roads_geodata <- readOGR(file, layer="TLM_STRASSE")
# View(roads_geodata)

````



````{r}

#plot(roads_geodata[1:10000,])

# ggplot() + 
#   geom_sf(data = roads_geodata[1:10,], size = 3, color = "black", fill = "cyan1") + 
#   ggtitle("AOI Boundary Plot") + 
#   coord_sf()

````

###

````{r}

library(readxl)
municipalities <- read_excel("data/municipalities/be-t-00.04-agv-01.xlsx", 
    sheet = "GDE")
head(municipalities)

````

````{r}

accidents_df <- left_join(accidents_df, municipalities[,c("GDENR", "GDENAMK")], by = join_by("MunicipalityCode" == "GDENR"))

head(accidents_df)

````

# Analysis


```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentYear, AccidentSeverityCategory_en) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = AccidentYear, y = Count, fill = AccidentSeverityCategory_en)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Accidents per year",
       x = "Year",
       y = "Nr. of accidents",
       fill = "Accident Severity")
  
```

```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth) %>% 
  summarise(Count = n()) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count, fill = Count)) +
  geom_bar(stat = "identity") + 
  scale_fill_continuous(type = "gradient", trans = "reverse") +
  scale_x_discrete() +
  labs(title = "Most accidents happen in the summer",
       x = "Month",
       y = "Nr. of accidents")
  
```
Maybe because tourists travel through switzerland in summer? have a look at accidents on main roads in summer


```{r, echo=FALSE}

accidents_df %>% 
  group_by(AccidentMonth, RoadType_en) %>% 
  summarise(Count = n()) %>% 
  arrange(.,desc(Count)) %>% 
  ggplot(mapping = aes(x = factor(AccidentMonth), y = Count)) +
  geom_bar(stat = "identity") +
  facet_wrap( ~ RoadType_en) +
  scale_x_discrete() +
  labs(title = "Accidents per road type during the year",
       x = "Month",
       y = "Nr. of accidents")
  
```

Analyse Weekdays/Hours

````{r heatmap_of_accidents, echo = FALSE}

accidents_df[,c("AccidentUID", "AccidentWeekDay", "AccidentHour")] %>%
  group_by(AccidentWeekDay, AccidentHour) %>% 
  summarise(Count = n()) %>% 
  mutate(AccidentWeekDay_f=factor(x = AccidentWeekDay,levels = rev(c("aw401", "aw402", "aw403", "aw404", "aw405", "aw406", "aw407"
)), labels = rev(c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))) %>% 
  # pull(AccidentWeekDay_f) %>% levels() %>% dput
  ggplot(aes(x = AccidentHour, y = AccidentWeekDay_f, fill = Count)) +
    geom_raster() +
    labs(x = 'Hour', y = "Day of  the Week", title = "Most Accidents happen on weekdays in the evening") +
    theme_minimal()

````

````{r map_of_accidents_by_road_type, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "RoadType_en")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````


````{r map_of_accidents, echo = FALSE}

accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentWeekDay")] %>%
  mutate(Weekend = AccidentWeekDay %in% c("aw406", "aw407")) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = Weekend)) +
    geom_point(alpha = 0.01) +
    facet_wrap(~Weekend) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Day") +
    scale_color_discrete(labels=c('Weekday', 'Weekend')) +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

````{r map_of_accidents_pedestrians, echo = FALSE}
accidents_df[,c("AccidentLocation_CHLV95_E", "AccidentLocation_CHLV95_N", "AccidentInvolvingPedestrian")] %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, 
             y = AccidentLocation_CHLV95_N, 
             colour = AccidentInvolvingPedestrian)) +
    geom_point(alpha = 0.1) +
    facet_wrap( ~AccidentInvolvingPedestrian, nrow = 2) +
    labs(x = 'E', y = "N", title = "Map of accidents", colour = "Pedestrian") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed()

````

### Most accidents by municipality

`````{r }

library(knitr)

accidents_df %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Most dangerous municipalites")
`````

`````{r }

library(knitr)

accidents_df %>% 
  filter(AccidentSeverityCategory == "as1") %>% 
  group_by(MunicipalityCode) %>% 
  summarise(total = n()) %>% 
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  kable(caption = "Municipalities with most fatalities in accidents")
`````


````{r map_of_accidents_by_road_type, echo = FALSE}

map_acc <- accidents_df %>%
  filter(AccidentSeverityCategory == "as1") %>%
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, label = GDENAMK, color = RoadType_en)) +
    geom_point(alpha = 1) +
    labs(x = 'E', y = "N", title = "Map of fatal accidents") +
    theme_minimal() +
    coord_fixed()

plotly::ggplotly(map_acc)

````

# Model

```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = AccidentSeverityCategory_en)) +
  geom_bar() +
  facet_wrap(~ AccidentSeverityCategory_en, scales = "free") +
  labs(x = "Number of accidents")  

```

```{r}

# model <- lm(AccidentSeverityCategory ~ RoadType, data = accidents_df)
# summary(model)

ggplot(data = accidents_df, aes(y = AccidentHour, fill = RoadType_en)) +
  geom_bar() +
  facet_wrap(~ RoadType_en) +
  labs(x = "Number of accidents")  

```

````{r map_of_accidents_by_road_type, echo = FALSE}

accidents_df %>%
  filter(MunicipalityCode == 261) %>% 
  ggplot(aes(x = AccidentLocation_CHLV95_E, y = AccidentLocation_CHLV95_N, colour = RoadType_en)) +
    geom_point(alpha = 0.1) +
    labs(x = 'E', y = "N", title = "Map of accidents in ZH") +
    theme_minimal() +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    coord_fixed() + 
    labs(colour = "Type of road")

````

```{r}

# model <- lm(factor(AccidentSeverityCategory) ~ AccidentHour, data = accidents_df[,!is.na("AccidentSeverityCategory")])
# summary(model)

model_data <- accidents_df %>% 
  group_by(AccidentSeverityCategory_en, AccidentHour) %>% 
  summarise(count = n()) %>% 
  mutate(severity = factor(AccidentSeverityCategory_en))

ggplot(data = model_data, mapping = aes(x = AccidentHour, y = count, group_by = severity)) +
  geom_line()


```


Thanks, bye!